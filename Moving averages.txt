//+------------------------------------------------------------------+
//|                                        MASellOnConditionEA.mq5 |
//|                                         Your Name/Company Name |
//|                                      https://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Your Name/Company Name"
#property link      "https://www.mql5.com"
#property version   "1.00"
#property description "Sells when MA200 > MA100"

// Include the trade handling library
#include <Trade\Trade.mqh>

//--- input parameters
input int    MA100_Period = 100; // Moving Average 100 Period
input int    MA200_Period = 200; // Moving Average 200 Period
input ENUM_MA_METHOD MA_Method = MODE_SMA; // MA Method (SMA, EMA, etc.)
input ENUM_APPLIED_PRICE MA_AppliedPrice = PRICE_CLOSE; // Applied price
input double LotSize = 0.1; // Trading volume

//--- global variables
int    MA100_Handle;
int    MA200_Handle;
double MA100_Buffer[];
double MA200_Buffer[];
CTrade trade; // Create an instance of the CTrade class

//+------------------------------------------------------------------+
//| Expert initialization function |
//+------------------------------------------------------------------+
int OnInit()
{
    //--- create indicator handles
    MA100_Handle = iMA(_Symbol, _Period, MA100_Period, 0, MA_Method, MA_AppliedPrice);
    MA200_Handle = iMA(_Symbol, _Period, MA200_Period, 0, MA_Method, MA_AppliedPrice);

    // Check for invalid handles
    if (MA100_Handle == INVALID_HANDLE || MA200_Handle == INVALID_HANDLE)
    {
        Print("Error creating MA indicators. Error code: ", GetLastError());
        return(INIT_FAILED);
    }

    //--- set as series to have index 0 as the current bar
    ArraySetAsSeries(MA100_Buffer, true);
    ArraySetAsSeries(MA200_Buffer, true);

    //---
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| Expert deinitialization function |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
    //--- release indicator handles
    if (MA100_Handle != INVALID_HANDLE) IndicatorRelease(MA100_Handle);
    if (MA200_Handle != INVALID_HANDLE) IndicatorRelease(MA200_Handle);
}

//+------------------------------------------------------------------+
//| Expert tick function |
//+------------------------------------------------------------------+
void OnTick()
{
    // Ensure we have enough bars to calculate the MAs
    if (Bars(_Symbol, _Period) < MA200_Period + 2) return;

    // Get the latest MA values
    if (CopyBuffer(MA100_Handle, 0, 0, 2, MA100_Buffer) != 2 || CopyBuffer(MA200_Handle, 0, 0, 2, MA200_Buffer) != 2)
    {
        Print("Error copying indicator buffer data. Error code: ", GetLastError());
        return;
    }

    // Get current and previous values
    double ma100_current = MA100_Buffer[0];
    double ma200_current = MA200_Buffer[0];
    double ma100_previous = MA100_Buffer[1];
    double ma200_previous = MA200_Buffer[1];

    // Check for the condition: MA200 > MA100 (current and previous)
    // This condition can act as a trend filter.
    bool trend_is_bearish = (ma200_current > ma100_current);

    // Additionally, check for a crossover to use as an entry trigger (optional, adjust as needed)
    // The user's request is "when moving average 200 is greater than moving average 100", 
    // implying this condition is the signal itself, not a crossover.
    
    // Check if a position is already open
    if (PositionSelect(_Symbol) == false) // No open position
    {
        if (trend_is_bearish)
        {
            // Open a sell position
            // Normalize prices to correct digits
            double ask_price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
            trade.PositionOpen(_Symbol, ORDER_TYPE_SELL, LotSize, ask_price, 0, 0, 0, "MA Sell Signal");
        }
    }
}
